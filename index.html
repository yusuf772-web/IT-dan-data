<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kalender IT dan Data Center</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kalender IT">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json" onerror="this.onerror=null;this.href='data:application/json;base64,e30='">
    <link rel="apple-touch-icon" href="images/icon.png" onerror="this.onerror=null;this.src='https://placehold.co/180x180/0f172a/ffffff?text=IT'">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { transition: all 0.2s ease-in-out; }
        .event-dot { width: 5px; height: 5px; border-radius: 50%; }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.5); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal.hidden { pointer-events: none; }
        .modal.hidden .modal-backdrop { opacity: 0; }
        .modal.hidden .modal-content { transform: scale(0.95) translateY(10px); opacity: 0; }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        .filter-btn, .nav-btn { color: #cbd5e1; background-color: transparent; transition: all 0.2s ease-in-out; }
        .filter-btn.active, .nav-btn.active { background-color: #475569; color: #f1f5f9; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .custom-checkbox { -webkit-appearance: none; appearance: none; background-color: #334155; border: 0.15em solid #64748b; margin: 0; font: inherit; color: currentColor; width: 1.25em; height: 1.25em; border-radius: 0.25rem; transform: translateY(-0.075em); display: grid; place-content: center; cursor: pointer; transition: all 0.1s ease-in-out; }
        .custom-checkbox::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: bottom left; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked::before { transform: scale(1); }
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .sortable-header {
            cursor: pointer;
        }
        .sort-icon {
            transition: color 0.2s ease-in-out;
            color: #64748b; /* Default icon color */
        }
        .sort-icon.active {
            color: #3b82f6; /* Active icon color */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">
        <h1 class="text-3xl font-bold text-white mb-4 text-center">Kalender IT dan Data Center</h1>

        <!-- Navigation between views -->
        <div class="mb-6 flex justify-center">
            <div class="bg-slate-800 rounded-lg p-1 flex items-center gap-1 w-full sm:w-auto">
                <button data-action="navigate" data-view="calendar" class="nav-btn active w-full px-4 py-1.5 text-sm font-semibold rounded-md">Kalender</button>
                <button data-action="navigate" data-view="wifi" class="nav-btn w-full px-4 py-1.5 text-sm font-semibold rounded-md">Database WiFi</button>
            </div>
        </div>

        <!-- VIEW 1: Calendar -->
        <div id="calendar-view">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3">
                    <div class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <button data-action="prev-month" class="p-2 rounded-full hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h2 id="month-year" class="text-xl font-semibold text-slate-200"></h2>
                            <button data-action="next-month" class="p-2 rounded-full hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                        <div class="calendar-grid text-center font-medium text-sm text-slate-400 mb-2">
                            <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                        </div>
                        <div id="calendar-dates" class="calendar-grid"></div>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <div class="space-y-4 sm:space-y-0 sm:inline-flex sm:flex-row sm:gap-3 sm:items-center">
                            <button data-action="open-add-modal" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Tambah Jadwal
                             </button>
                             <div id="filter-container" class="bg-slate-700 rounded-lg p-1 flex items-center gap-1 w-full sm:w-auto">
                                <button data-action="filter" data-filter="all" class="filter-btn active w-full px-4 py-1.5 text-sm font-semibold rounded-md">Semua</button>
                                <button data-action="filter" data-filter="not-done" class="filter-btn w-full px-4 py-1.5 text-sm font-semibold rounded-md">Belum</button>
                                <button data-action="filter" data-filter="done" class="filter-btn w-full px-4 py-1.5 text-sm font-semibold rounded-md">Selesai</button>
                            </div>
                        </div>
                    </div>
                    <div id="color-legend" class="mt-6 bg-slate-800 p-4 rounded-2xl shadow-lg">
                        <h4 class="text-lg font-semibold text-white mb-3">Keterangan Warna</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span><span class="text-slate-300">WiFi</span></div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span><span class="text-slate-300">Jaringan</span></div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-purple-500"></span><span class="text-slate-300">Website</span></div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 flex flex-col gap-8">
                    <div>
                        <h3 class="text-2xl font-bold text-white mb-4">Jadwal untuk <span id="selected-date-display" class="text-blue-400"></span></h3>
                        <div class="bg-slate-800 p-2 rounded-xl shadow-lg max-h-[45vh] overflow-y-auto"><div id="event-list" class="space-y-2"></div></div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white mb-4">Tugas Terlewat</h3>
                        <div class="bg-slate-800 p-2 rounded-xl shadow-lg max-h-[45vh] overflow-y-auto"><div id="overdue-tasks-list" class="space-y-2"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: WiFi Database -->
        <div id="wifi-view" class="hidden">
            <div class="bg-slate-800 p-4 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold text-white">Database WiFi</h2>
                    <button data-action="open-add-wifi-modal" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>Tambah WiFi</span>
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                    <div class="relative w-full sm:w-1/2 lg:w-1/3">
                        <input type="text" id="wifi-search" placeholder="Cari WiFi..." class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <button data-action="reset-wifi-filters" class="w-full sm:w-auto bg-slate-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-slate-500 transition-colors">Reset Pencarian</button>
                </div>
                <div id="wifi-list-container" class="overflow-x-auto">
                    <!-- WiFi table will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Base -->
    <div id="modal-template" class="modal fixed inset-0 z-50 flex items-center justify-center hidden" data-action="close-modal-backdrop">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-md m-4 relative"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3 transform translate-y-20 opacity-0 transition-all duration-300 ease-out z-50">
        <svg id="toast-icon" class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <p id="toast-message"></p>
        <button data-action="close-toast" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <!-- Main App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyC35pjxZjBE6s7fbZHP4YmsH20772WbMHo",
          authDomain: "it-dan-data-center.firebaseapp.com",
          projectId: "it-dan-data-center",
          storageBucket: "it-dan-data-center.appspot.com",
          messagingSenderId: "1044193053475",
          appId: "1:1044193053475:web:fdfe0bc2bea9fd19e4da96"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const state = {
            currentView: 'calendar',
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDate: new Date(),
            events: [],
            wifiList: [],
            currentFilter: 'all',
            wifiSearchQuery: '',
            // ### REMOVED: wifiFilters state is no longer needed ###
            wifiSort: {
                key: 'wifiName', 
                direction: 'asc'
            },
            unsubscribeEvents: null,
            unsubscribeWifi: null,
            toastTimeout: null,
        };

        const DOMElements = {
            appContainer: document.getElementById('app-container'),
            calendarView: document.getElementById('calendar-view'),
            wifiView: document.getElementById('wifi-view'),
            calendarDates: document.getElementById('calendar-dates'),
            monthYear: document.getElementById('month-year'),
            selectedDateDisplay: document.getElementById('selected-date-display'),
            eventList: document.getElementById('event-list'),
            overdueTasksList: document.getElementById('overdue-tasks-list'),
            wifiListContainer: document.getElementById('wifi-list-container'),
            wifiSearchInput: document.getElementById('wifi-search'),
            modalTemplate: document.getElementById('modal-template'),
            modalContent: document.querySelector('#modal-template .modal-content'),
            toast: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message'),
            filterContainer: document.getElementById('filter-container'),
        };

        const CATEGORY_STYLES = {
            wifi:     { border: 'border-blue-500',   bg: 'bg-blue-500'   },
            jaringan: { border: 'border-green-500',  bg: 'bg-green-500'  },
            website:  { border: 'border-purple-500', bg: 'bg-purple-500' },
            default:  { border: 'border-gray-500',   bg: 'bg-gray-500'   },
        };

        const toYYYYMMDD = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const fromYYYYMMDD = (str) => new Date(str + 'T00:00:00');
        const escapeHtml = (str) => String(str ?? '').replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[match]));

        // --- View Rendering ---
        function renderCalendar() {
            DOMElements.calendarDates.innerHTML = '';
            const date = new Date(state.currentYear, state.currentMonth, 1);
            DOMElements.monthYear.textContent = date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
            const firstDay = date.getDay();
            const lastDate = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            const prevLastDate = new Date(state.currentYear, state.currentMonth, 0).getDate();
            for (let i = firstDay; i > 0; i--) {
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 h-14 text-center text-slate-500';
                dayEl.textContent = prevLastDate - i + 1;
                DOMElements.calendarDates.appendChild(dayEl);
            }
            for (let i = 1; i <= lastDate; i++) {
                const dayDate = new Date(state.currentYear, state.currentMonth, i);
                const dateString = toYYYYMMDD(dayDate);
                const isToday = toYYYYMMDD(new Date()) === dateString;
                const isSelected = toYYYYMMDD(state.selectedDate) === dateString;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day p-2 h-14 text-center cursor-pointer rounded-full relative flex flex-col items-center justify-center';
                dayEl.dataset.action = 'select-date';
                dayEl.dataset.date = dateString;
                dayEl.textContent = i;
                if (isSelected) dayEl.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-blue-600', 'text-white', 'font-bold', 'shadow-md');
                else if (isToday) dayEl.classList.add('bg-slate-700', 'text-slate-100', 'font-semibold');
                else dayEl.classList.add('hover:bg-slate-700');
                const eventsOnDay = state.events.filter(e => e.date === dateString);
                if (eventsOnDay.length > 0) {
                    const dotEl = document.createElement('div');
                    dotEl.className = 'event-dot mt-1';
                    const primaryCategory = ['website', 'jaringan', 'wifi'].find(cat => eventsOnDay.some(e => e.category === cat)) || 'default';
                    dotEl.classList.add(CATEGORY_STYLES[primaryCategory]?.bg || CATEGORY_STYLES.default.bg);
                    dayEl.appendChild(dotEl);
                }
                DOMElements.calendarDates.appendChild(dayEl);
            }
        }

        function renderEventList() {
            DOMElements.selectedDateDisplay.textContent = state.selectedDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
            DOMElements.eventList.innerHTML = '';
            const dateString = toYYYYMMDD(state.selectedDate);
            let filteredEvents = state.events.filter(event => event.date === dateString);
            if (state.currentFilter === 'done') filteredEvents = filteredEvents.filter(event => event.status);
            else if (state.currentFilter === 'not-done') filteredEvents = filteredEvents.filter(event => !event.status);
            if (filteredEvents.length === 0) {
                DOMElements.eventList.innerHTML = `<div class="text-center py-16 px-4"><svg class="mx-auto h-12 w-12 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><h3 class="mt-2 text-sm font-medium text-slate-200">Tidak ada jadwal</h3><p class="mt-1 text-sm text-slate-400">Belum ada jadwal untuk tanggal ini.</p></div>`;
                return;
            }
            filteredEvents.sort((a, b) => a.title.localeCompare(b.title));
            filteredEvents.forEach(event => {
                const eventEl = createEventElement(event);
                DOMElements.eventList.appendChild(eventEl);
            });
        }
        
        function renderOverdueTasks() {
            DOMElements.overdueTasksList.innerHTML = '';
            const todayString = toYYYYMMDD(new Date());
            const overdueEvents = state.events.filter(event => event.date < todayString && !event.status).sort((a, b) => a.date.localeCompare(b.date));
            if (overdueEvents.length === 0) {
                DOMElements.overdueTasksList.innerHTML = `<div class="text-center py-16 px-4"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-2 text-sm font-medium text-slate-200">Kerja Bagus!</h3><p class="mt-1 text-sm text-slate-400">Tidak ada tugas yang terlewat.</p></div>`;
                return;
            }
            overdueEvents.forEach(event => {
                const eventEl = createEventElement(event, true); 
                DOMElements.overdueTasksList.appendChild(eventEl);
            });
        }

        function createEventElement(event, showDate = false) {
            const eventEl = document.createElement('div');
            const { id, category = 'default', status, title, description, location, ipAddress, date } = event;
            const catStyle = CATEGORY_STYLES[category] || CATEGORY_STYLES.default;
            eventEl.className = `p-3 rounded-lg border-l-4 ${catStyle.border} flex items-start justify-between gap-4 ${status ? 'bg-slate-700/50' : 'bg-slate-800 shadow-sm'}`;
            eventEl.dataset.eventId = id;
            let detailsHTML = `<p class="font-semibold text-slate-100">${escapeHtml(title)}</p>`;
            if (showDate) {
                const eventDate = fromYYYYMMDD(date);
                detailsHTML += `<p class="text-xs text-amber-400 font-semibold">${eventDate.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'})}</p>`;
            }
            if (location) detailsHTML += `<p class="text-sm text-slate-400 mt-1"><strong>Lokasi:</strong> ${escapeHtml(location)}</p>`;
            if (ipAddress) detailsHTML += `<p class="text-sm text-slate-400"><strong>IP:</strong> ${escapeHtml(ipAddress)}</p>`;
            if (description) detailsHTML += `<p class="text-sm text-slate-400 mt-1 whitespace-pre-wrap">${escapeHtml(description)}</p>`;
            eventEl.innerHTML = `<div class="flex items-start gap-3 flex-grow"><input type="checkbox" data-action="toggle-status" class="custom-checkbox status-checkbox mt-1" ${status ? 'checked' : ''}><div class="flex-grow ${status ? 'opacity-60 line-through' : ''}">${detailsHTML}</div></div><div class="flex items-center gap-1 flex-shrink-0"><button data-action="edit-event" class="text-slate-400 hover:text-blue-400 p-1 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button><button data-action="delete-event" class="text-slate-400 hover:text-red-500 p-1 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
            return eventEl;
        }

        /**
         * ### MODIFIED: Renders the WiFi list table with search and sorting, dropdowns removed. ###
         */
        function renderWifiList() {
            const container = DOMElements.wifiListContainer;
            container.innerHTML = '';

            const { wifiSearchQuery, wifiSort } = state;
            const searchQuery = wifiSearchQuery.toLowerCase();
            
            let processedList = state.wifiList
                .filter(wifi => {
                    return searchQuery ? (
                        wifi.wifiName.toLowerCase().includes(searchQuery) ||
                        wifi.location.toLowerCase().includes(searchQuery) ||
                        wifi.ipAddress.toLowerCase().includes(searchQuery) ||
                        wifi.area.toLowerCase().includes(searchQuery)
                    ) : true;
                });

            processedList.sort((a, b) => {
                const valA = a[wifiSort.key] ? a[wifiSort.key].toLowerCase() : '';
                const valB = b[wifiSort.key] ? b[wifiSort.key].toLowerCase() : '';
                if (valA < valB) return wifiSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return wifiSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (processedList.length === 0) {
                container.innerHTML = `<div class="text-center py-16 px-4"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071a10 10 0 0114.142 0M1.394 9.343a15 15 0 0121.213 0" /></svg><h3 class="mt-2 text-sm font-medium text-slate-200">Tidak ada data ditemukan</h3><p class="mt-1 text-sm text-slate-400">Coba ubah kata kunci pencarian Anda.</p></div>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-slate-400';
            
            const createSortIcon = (key) => {
                const isSorted = wifiSort.key === key;
                const ascActive = isSorted && wifiSort.direction === 'asc';
                const descActive = isSorted && wifiSort.direction === 'desc';
                return `
                    <span class="inline-flex flex-col ml-2">
                        <svg class="w-3 h-3 sort-icon ${ascActive ? 'active' : ''}" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 3.293a1 1 0 00-1.414 0l-6 6a1 1 0 001.414 1.414L10 5.414l5.293 5.293a1 1 0 001.414-1.414l-6-6z"></path></svg>
                        <svg class="w-3 h-3 sort-icon ${descActive ? 'active' : ''}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.293 16.707a1 1 0 001.414 0l6-6a1 1 0 00-1.414-1.414L10 14.586 4.707 9.293a1 1 0 00-1.414 1.414l6 6z"></path></svg>
                    </span>
                `;
            };

            table.innerHTML = `
                <thead class="text-xs text-slate-300 uppercase bg-slate-700/50">
                    <tr>
                        <th scope="col" class="px-4 py-3"><div data-action="sort-wifi" data-sort-key="wifiName" class="flex items-center sortable-header">Nama WiFi ${createSortIcon('wifiName')}</div></th>
                        <th scope="col" class="px-4 py-3">Sandi</th>
                        <th scope="col" class="px-4 py-3"><div data-action="sort-wifi" data-sort-key="area" class="flex items-center sortable-header">Area ${createSortIcon('area')}</div></th>
                        <th scope="col" class="px-4 py-3"><div data-action="sort-wifi" data-sort-key="location" class="flex items-center sortable-header">Lokasi ${createSortIcon('location')}</div></th>
                        <th scope="col" class="px-4 py-3"><div data-action="sort-wifi" data-sort-key="ipAddress" class="flex items-center sortable-header">Alamat IP ${createSortIcon('ipAddress')}</div></th>
                        <th scope="col" class="px-4 py-3 text-right">Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

            const tbody = table.querySelector('tbody');
            processedList.forEach(wifi => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700 hover:bg-slate-700/30';
                tr.dataset.wifiId = wifi.id;
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-slate-100 whitespace-nowrap">${escapeHtml(wifi.wifiName)}</td>
                    <td class="px-4 py-3"><div class="flex items-center gap-2"><span class="password-text" data-type="password">••••••••</span><button data-action="toggle-password" class="text-slate-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button></div></td>
                    <td class="px-4 py-3">${escapeHtml(wifi.area)}</td>
                    <td class="px-4 py-3">${escapeHtml(wifi.location)}</td>
                    <td class="px-4 py-3">${escapeHtml(wifi.ipAddress)}</td>
                    <td class="px-4 py-3 text-right"><div class="flex items-center justify-end gap-2"><button data-action="edit-wifi" class="text-slate-400 hover:text-blue-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button><button data-action="delete-wifi" class="text-slate-400 hover:text-red-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></td>
                `;
                tbody.appendChild(tr);
            });
            container.appendChild(table);
        }

        // --- Modals ---
        function openModal(content) {
            DOMElements.modalContent.innerHTML = content;
            DOMElements.modalTemplate.classList.remove('hidden');
        }

        function closeModal() {
            DOMElements.modalTemplate.classList.add('hidden');
            DOMElements.modalContent.innerHTML = '';
        }

        function showFormModal(isEdit = false, event = {}) {
            const title = isEdit ? 'Edit Jadwal' : 'Tambah Jadwal Baru';
            const buttonText = isEdit ? 'Simpan Perubahan' : 'Tambah';
            const eventIdInput = isEdit ? `<input type="hidden" name="id" value="${event.id}">` : '';
            const inputClasses = "w-full px-4 py-2 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-700 text-slate-100";
            const modalContent = `<form id="event-form" class="space-y-4">${eventIdInput}<h3 class="text-xl font-bold mb-2 text-slate-100">${title}</h3><div><label class="block text-sm font-medium text-slate-300 mb-1">Pilih Kategori</label><select name="category" class="${inputClasses} outline-none transition"></select></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Judul Kegiatan</label><input type="text" name="title" placeholder="e.g., Perbaikan Router" class="${inputClasses}" value="${escapeHtml(event.title || '')}" required></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Lokasi</label><input type="text" name="location" placeholder="e.g., Lantai 5, Ruang Server" class="${inputClasses}" value="${escapeHtml(event.location || '')}" required></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Alamat IP (Opsional)</label><input type="text" name="ipAddress" placeholder="e.g., 192.168.1.1" class="${inputClasses}" value="${escapeHtml(event.ipAddress || '')}"></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Deskripsi (Opsional)</label><textarea name="description" placeholder="Tulis deskripsi atau catatan di sini..." class="${inputClasses}" rows="3">${escapeHtml(event.description || '')}</textarea></div><div class="mt-6 flex justify-end gap-3"><button type="button" data-action="close-modal" class="px-4 py-2 bg-slate-600 text-slate-100 rounded-lg hover:bg-slate-500 transition-colors">Batal</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">${buttonText}</button></div></form>`;
            openModal(modalContent);
            const form = document.getElementById('event-form');
            const categorySelect = form.querySelector('[name="category"]');
            const categories = { wifi: 'WiFi', jaringan: 'Jaringan', website: 'Website' };
            const categoryToSelect = event.category || 'wifi';
            for (const [value, text] of Object.entries(categories)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (value === categoryToSelect) option.selected = true;
                categorySelect.appendChild(option);
            }
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handleEventFormSubmit(form);
            });
        }

        function showWifiFormModal(isEdit = false, wifi = {}) {
            const title = isEdit ? 'Edit Data WiFi' : 'Tambah Data WiFi Baru';
            const buttonText = isEdit ? 'Simpan Perubahan' : 'Tambah';
            const wifiIdInput = isEdit ? `<input type="hidden" name="id" value="${wifi.id}">` : '';
            const inputClasses = "w-full px-4 py-2 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-700 text-slate-100";
            const area = wifi.area || 'Ikhwan';
            const modalContent = `<form id="wifi-form" class="space-y-4">${wifiIdInput}<h3 class="text-xl font-bold mb-2 text-slate-100">${title}</h3><div><label class="block text-sm font-medium text-slate-300 mb-1">Nama WiFi</label><input type="text" name="wifiName" placeholder="e.g., WiFi_Lantai_1" class="${inputClasses}" value="${escapeHtml(wifi.wifiName || '')}" required></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Sandi</label><input type="text" name="password" placeholder="Sandi WiFi" class="${inputClasses}" value="${escapeHtml(wifi.password || '')}" required></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Alamat IP</label><input type="text" name="ipAddress" placeholder="e.g., 192.168.1.1" class="${inputClasses}" value="${escapeHtml(wifi.ipAddress || '')}" required></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Lokasi</label><input type="text" name="location" placeholder="e.g., Sebelah Ruang Rapat" class="${inputClasses}" value="${escapeHtml(wifi.location || '')}" required></div><div><label class="block text-sm font-medium text-slate-300 mb-1">Area</label><div class="flex gap-4 mt-2"><label class="flex items-center gap-2 text-slate-200"><input type="radio" name="area" value="Ikhwan" class="w-4 h-4" ${area === 'Ikhwan' ? 'checked' : ''}> Ikhwan</label><label class="flex items-center gap-2 text-slate-200"><input type="radio" name="area" value="Akhwat" class="w-4 h-4" ${area === 'Akhwat' ? 'checked' : ''}> Akhwat</label></div></div><div class="mt-6 flex justify-end gap-3"><button type="button" data-action="close-modal" class="px-4 py-2 bg-slate-600 text-slate-100 rounded-lg hover:bg-slate-500 transition-colors">Batal</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">${buttonText}</button></div></form>`;
            openModal(modalContent);
            document.getElementById('wifi-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleWifiFormSubmit(e.target);
            });
        }

        function showDeleteConfirmationModal(type, itemId) {
            const itemText = type === 'event' ? 'Jadwal' : 'Data WiFi';
            const content = `<div class="text-center"><h3 class="text-lg font-medium text-white">Hapus ${itemText}?</h3><p class="mt-2 text-sm text-slate-400">Tindakan ini tidak dapat diurungkan.</p><div class="mt-6 flex justify-center gap-3"><button type="button" data-action="close-modal" class="px-4 py-2 bg-slate-600 text-slate-100 rounded-lg hover:bg-slate-500 transition-colors">Batal</button><button type="button" data-action="confirm-delete" data-item-type="${type}" data-item-id="${itemId}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Ya, Hapus</button></div></div>`;
            openModal(content);
        }
        
        function showToast(message) {
            if (state.toastTimeout) clearTimeout(state.toastTimeout);
            DOMElements.toastMessage.textContent = message;
            DOMElements.toast.classList.remove('translate-y-20', 'opacity-0');
            DOMElements.toast.classList.add('translate-y-0', 'opacity-100');
            state.toastTimeout = setTimeout(() => {
                DOMElements.toast.classList.add('translate-y-20', 'opacity-0');
            }, 4000);
        }
        
        // --- Firebase Functions ---
        async function handleEventFormSubmit(form) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const eventId = data.id;
            const isEdit = !!eventId;
            if (!data.title?.trim() || !data.location?.trim()) {
                showToast('Judul dan Lokasi tidak boleh kosong!');
                return;
            }
            const eventData = { category: data.category, title: data.title, location: data.location, ipAddress: data.ipAddress || null, description: data.description || null };
            try {
                if (isEdit) {
                    await updateDoc(doc(db, 'it_tasks', eventId), eventData);
                    showToast('Jadwal berhasil diperbarui.');
                } else {
                    eventData.date = toYYYYMMDD(state.selectedDate);
                    eventData.status = false;
                    eventData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'it_tasks'), eventData);
                    showToast('Jadwal berhasil ditambahkan.');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving event: ", error);
                showToast('Gagal menyimpan jadwal.');
            }
        }

        async function handleWifiFormSubmit(form) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const wifiId = data.id;
            const isEdit = !!wifiId;
            if (!data.wifiName?.trim() || !data.password?.trim() || !data.ipAddress?.trim() || !data.location?.trim()) {
                showToast('Semua field wajib diisi!');
                return;
            }
            const wifiData = { wifiName: data.wifiName, password: data.password, ipAddress: data.ipAddress, location: data.location, area: data.area };
            try {
                if (isEdit) {
                    await updateDoc(doc(db, 'wifi_credentials', wifiId), wifiData);
                    showToast('Data WiFi berhasil diperbarui.');
                } else {
                    wifiData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'wifi_credentials'), wifiData);
                    showToast('Data WiFi berhasil ditambahkan.');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving wifi data: ", error);
                showToast('Gagal menyimpan data WiFi.');
            }
        }

        async function handleToggleStatus(eventId, status) {
            try {
                await updateDoc(doc(db, 'it_tasks', eventId), { status });
            } catch (error) {
                console.error("Error updating status: ", error);
                showToast('Gagal memperbarui status.');
            }
        }

        async function handleDeleteItem(type, itemId) {
            const collectionName = type === 'event' ? 'it_tasks' : 'wifi_credentials';
            const itemText = type === 'event' ? 'Jadwal' : 'Data WiFi';
            try {
                await deleteDoc(doc(db, collectionName, itemId));
                showToast(`${itemText} telah dihapus.`);
                closeModal();
            } catch (error) {
                console.error(`Error deleting ${type}: `, error);
                showToast(`Gagal menghapus ${itemText}.`);
            }
        }

        function listenForEvents() {
            if (state.unsubscribeEvents) state.unsubscribeEvents(); 
            const q = query(collection(db, 'it_tasks'));
            state.unsubscribeEvents = onSnapshot(q, (querySnapshot) => {
                state.events = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentView === 'calendar') {
                    renderCalendar();
                    renderEventList();
                    renderOverdueTasks();
                }
            }, (error) => console.error("Error listening to events: ", error));
        }

        function listenForWifiData() {
            if (state.unsubscribeWifi) state.unsubscribeWifi();
            const q = query(collection(db, 'wifi_credentials'));
            state.unsubscribeWifi = onSnapshot(q, (querySnapshot) => {
                state.wifiList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentView === 'wifi') {
                    renderWifiList();
                }
            }, (error) => {
                console.error("Error listening to wifi data: ", error);
                if (state.currentView === 'wifi') showToast("Gagal memuat data WiFi. Periksa Security Rules.");
            });
        }
        
        // --- Global Event Delegation ---
        function handleAppClick(e) {
            const target = e.target;
            const actionTarget = target.closest('[data-action]');
            if (!actionTarget) return;
            const action = actionTarget.dataset.action;
            switch(action) {
                case 'navigate': {
                    const view = actionTarget.dataset.view;
                    if (state.currentView === view) return;
                    state.currentView = view;
                    document.querySelector('.nav-btn.active').classList.remove('active');
                    actionTarget.classList.add('active');
                    if (view === 'calendar') {
                        DOMElements.wifiView.classList.add('hidden');
                        DOMElements.calendarView.classList.remove('hidden');
                        renderCalendar();
                        renderEventList();
                        renderOverdueTasks();
                    } else {
                        DOMElements.calendarView.classList.add('hidden');
                        DOMElements.wifiView.classList.remove('hidden');
                        renderWifiList();
                    }
                    break;
                }
                case 'prev-month':
                    state.currentMonth--;
                    if (state.currentMonth < 0) { state.currentMonth = 11; state.currentYear--; }
                    renderCalendar();
                    break;
                case 'next-month':
                    state.currentMonth++;
                    if (state.currentMonth > 11) { state.currentMonth = 0; state.currentYear++; }
                    renderCalendar();
                    break;
                case 'select-date':
                    state.selectedDate = fromYYYYMMDD(actionTarget.dataset.date);
                    renderCalendar();
                    renderEventList();
                    renderOverdueTasks();
                    break;
                case 'open-add-modal':
                    showFormModal(false);
                    break;
                case 'open-add-wifi-modal':
                    showWifiFormModal(false);
                    break;
                case 'filter':
                    state.currentFilter = actionTarget.dataset.filter;
                    DOMElements.filterContainer.querySelector('.active').classList.remove('active');
                    actionTarget.classList.add('active');
                    renderEventList();
                    break;
                case 'toggle-status': {
                    const eventId = actionTarget.closest('[data-event-id]').dataset.eventId;
                    handleToggleStatus(eventId, actionTarget.checked);
                    break;
                }
                case 'edit-event': {
                    const eventId = actionTarget.closest('[data-event-id]').dataset.eventId;
                    const eventToEdit = state.events.find(ev => ev.id === eventId);
                    if (eventToEdit) showFormModal(true, eventToEdit);
                    break;
                }
                case 'edit-wifi': {
                    const wifiId = actionTarget.closest('[data-wifi-id]').dataset.wifiId;
                    const wifiToEdit = state.wifiList.find(w => w.id === wifiId);
                    if (wifiToEdit) showWifiFormModal(true, wifiToEdit);
                    break;
                }
                case 'delete-event': {
                    const eventId = actionTarget.closest('[data-event-id]').dataset.eventId;
                    showDeleteConfirmationModal('event', eventId);
                    break;
                }
                case 'delete-wifi': {
                    const wifiId = actionTarget.closest('[data-wifi-id]').dataset.wifiId;
                    showDeleteConfirmationModal('wifi', wifiId);
                    break;
                }
                case 'confirm-delete':
                    handleDeleteItem(actionTarget.dataset.itemType, actionTarget.dataset.itemId);
                    break;
                case 'close-modal':
                case 'close-modal-backdrop':
                    if (action === 'close-modal-backdrop' && e.target !== actionTarget) return;
                    closeModal();
                    break;
                case 'close-toast':
                    DOMElements.toast.classList.add('translate-y-20', 'opacity-0');
                    break;
                case 'toggle-password': {
                    const row = actionTarget.closest('tr');
                    const wifiId = row.dataset.wifiId;
                    const wifiData = state.wifiList.find(w => w.id === wifiId);
                    const passSpan = row.querySelector('.password-text');
                    if (passSpan.dataset.type === 'password') {
                        passSpan.textContent = wifiData.password;
                        passSpan.dataset.type = 'text';
                    } else {
                        passSpan.textContent = '••••••••';
                        passSpan.dataset.type = 'password';
                    }
                    break;
                }
                case 'reset-wifi-filters': {
                    state.wifiSearchQuery = '';
                    // ### MODIFIED: Reset only search query ###
                    document.getElementById('wifi-search').value = '';
                    renderWifiList();
                    break;
                }
                case 'sort-wifi': {
                    const sortKey = actionTarget.dataset.sortKey;
                    if (state.wifiSort.key === sortKey) {
                        state.wifiSort.direction = state.wifiSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.wifiSort.key = sortKey;
                        state.wifiSort.direction = 'asc';
                    }
                    renderWifiList();
                    break;
                }
            }
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            DOMElements.appContainer.addEventListener('click', handleAppClick);
            DOMElements.modalTemplate.addEventListener('click', handleAppClick);
            
            DOMElements.wifiSearchInput.addEventListener('input', (e) => {
                state.wifiSearchQuery = e.target.value;
                renderWifiList();
            });
            
            listenForEvents();
            listenForWifiData();

            renderCalendar();
            renderEventList();
            renderOverdueTasks();
        });
    </script>
</body>
</html>
